<script>
const API_URL = "/api/movers";
const REFRESH_MS = 5 * 60 * 1000;

async function fetchData() {
  try {
    const res = await fetch(API_URL);
    const text = await res.text();
    let json; try { json = JSON.parse(text); } catch { throw new Error(text); }
    render(json.data || []);
  } catch (e) {
    document.getElementById("ticker").textContent = "âš ï¸ Unable to load data.";
    console.error(e);
  }
}

function render(cards) {
  const t = document.createElement("div");
  t.className = "ticker"; t.id = "ticker";

  cards.forEach(card => {
    const div = document.createElement("div");
    div.className = "ticker-item";
    div.style.cursor = "pointer";

    const emoji = card.pctChange >= 0 ? "ðŸš€" : "ðŸ’€";
    const arrow = card.pctChange >= 0 ? "â–²" : "â–¼";
    const pct = card.pctChange.toFixed(2);

    div.innerHTML = `
      <img src="${card.image}" width="60" height="84" style="vertical-align:middle; border-radius:4px; margin-right:6px;">
      ${emoji} <strong>${card.name}</strong> (${card.set}) ${arrow} ${pct}% - $${card.price.toFixed(2)}
    `;

    div.addEventListener("click", () => showPopup(card));
    t.appendChild(div);
  });

  document.querySelector(".ticker-wrap").replaceChild(t, document.getElementById("ticker"));
}

function showPopup(card) {
  if (!window.popup) {
    const overlay = document.createElement("div");
    Object.assign(overlay.style, {
      position: "fixed", inset: 0, background: "rgba(0,0,0,.8)",
      display: "flex", alignItems: "center", justifyContent: "center",
      zIndex: 9999
    });
    const box = document.createElement("div");
    Object.assign(box.style, {
      background: "#1e1e1e", color: "#fff", padding: "20px", borderRadius: "12px",
      width: "360px", textAlign: "center", fontFamily: "Consolas, monospace"
    });
    const img = document.createElement("img");
    img.style.width = "100%";
    img.style.borderRadius = "8px";
    const name = document.createElement("h3");
    const price = document.createElement("p");
    const trend = document.createElement("p");
    const close = document.createElement("button");
    close.textContent = "Close";
    close.style.marginTop = "10px";
    close.onclick = () => overlay.remove();

    box.append(img, name, price, trend, close);
    overlay.appendChild(box);
    window.popup = { overlay, img, name, price, trend };
  }

  window.popup.img.src = card.image;
  window.popup.name.textContent = card.name;
  window.popup.price.textContent = `Current Price: $${card.price.toFixed(2)}`;
  window.popup.trend.textContent = `Change (24h): ${card.pctChange.toFixed(2)}%`;
  document.body.appendChild(window.popup.overlay);
}

fetchData();
setInterval(fetchData, REFRESH_MS);
</script>
